# é…é¢é™åˆ¶åŠŸèƒ½ - å®æ–½æ€»ç»“ä¸æµ‹è¯•æŒ‡å—

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### é˜¶æ®µ 1ï¼šæ•°æ®åº“é…é¢åˆå§‹åŒ–

- âœ… åˆ›å»ºé…é¢åˆå§‹åŒ–è„šæœ¬ï¼ˆ`init-quota-config.ts` å’Œ `.sql`ï¼‰
- âœ… é…ç½®æ•°æ®ï¼šfree (2 æ¬¡/1000 è¯), premium (50 æ¬¡/5000 è¯)
- âœ… æ¸…ç†æ—§çš„ basic ç­‰çº§é…ç½®

### é˜¶æ®µ 2ï¼šåç«¯å­—æ•°é™åˆ¶éªŒè¯

- âœ… å¯¼å‡º `calculateWordCount` å‡½æ•°ä¾›è·¯ç”±ä½¿ç”¨
- âœ… å¢å¼º `QuotaInfo` æ¥å£æ·»åŠ  `maxArticleWords` å­—æ®µ
- âœ… åœ¨ `/api/text/analyze` è·¯ç”±å®ç°å­—æ•°éªŒè¯
- âœ… è¶…é™æ—¶è¿”å› 400 é”™è¯¯å¹¶æä¾›è¯¦ç»†ä¿¡æ¯

### é˜¶æ®µ 3ï¼šåç«¯é…é¢æŸ¥è¯¢ API

- âœ… å®ç° `GET /api/users/me/quota` è·¯ç”±
- âœ… è¿”å›å®Œæ•´é…é¢ä¿¡æ¯ï¼ˆtier, dailyLimit, usedToday, remainingToday, maxArticleWordsï¼‰

### é˜¶æ®µ 4ï¼šå‰ç«¯é…é¢æ˜¾ç¤º

- âœ… åˆ›å»º `useQuota` Hook è‡ªåŠ¨æŸ¥è¯¢é…é¢
- âœ… åˆ›å»º `QuotaInfoCard` ç»„ä»¶æ˜¾ç¤ºé…é¢ä¿¡æ¯å’Œè¿›åº¦æ¡
- âœ… é›†æˆåˆ° Dashboard é¡µé¢é¡¶éƒ¨
- âœ… åˆ†ææˆåŠŸåè‡ªåŠ¨åˆ·æ–°é…é¢

### é˜¶æ®µ 5ï¼šå‰ç«¯å­—æ•°éªŒè¯å’Œå‡çº§å¼•å¯¼

- âœ… å®æ—¶å­—æ•°ç»Ÿè®¡æ˜¾ç¤º
- âœ… è¶…é™æ—¶ç¦ç”¨åˆ†ææŒ‰é’®å¹¶æ ‡çº¢æç¤º
- âœ… å‰ç«¯å­—æ•°éªŒè¯æ‹¦æˆªè¶…é™è¯·æ±‚
- âœ… åˆ›å»ºå‡çº§å¼•å¯¼æ¨¡æ€æ¡†ç»„ä»¶
- âœ… æ•è·åç«¯ 400/429 é”™è¯¯å¹¶æ˜¾ç¤ºå‡çº§å¼¹çª—

## ğŸ“ å…³é”®æ–‡ä»¶

### åç«¯

- `projects/api/src/middleware/quota-check.middleware.ts` - é…é¢æ£€æŸ¥ä¸­é—´ä»¶ï¼ˆæ¬¡æ•°é™åˆ¶+æ³¨å…¥é…é¢ä¿¡æ¯ï¼‰
- `projects/api/src/route/text.route.ts` - å­—æ•°éªŒè¯é€»è¾‘ï¼ˆ400 é”™è¯¯ï¼‰
- `projects/api/src/route/user.route.ts` - é…é¢æŸ¥è¯¢ APIï¼ˆGET /api/users/me/quotaï¼‰
- `projects/api/src/service/article.service.ts` - å­—æ•°è®¡ç®—å‡½æ•°
- `projects/api/scripts/init-quota-config.ts` - é…é¢åˆå§‹åŒ–è„šæœ¬

### å‰ç«¯

- `projects/client/src/hooks/use-quota.ts` - é…é¢æŸ¥è¯¢ Hook
- `projects/client/src/components/dashboard/quota-info.tsx` - é…é¢å¡ç‰‡ç»„ä»¶
- `projects/client/src/components/dashboard/upgrade-modal.tsx` - å‡çº§å¼•å¯¼å¼¹çª—
- `projects/client/src/components/dashboard/article-analysis.tsx` - é›†æˆæ‰€æœ‰åŠŸèƒ½

## ğŸ“Š é…é¢è§„åˆ™

| ç­‰çº§    | æ¯æ—¥æ¬¡æ•° | å•ç¯‡å­—æ•° | ä»·æ ¼       |
| ------- | -------- | -------- | ---------- |
| free    | 2        | 1000     | $0ï¼ˆæ°¸ä¹…ï¼‰ |
| premium | 50       | 5000     | $7/æœˆ      |

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•æŒ‡å—

### ä¸€ã€æ•°æ®åº“åˆå§‹åŒ–éªŒè¯

**ç›®æ ‡**ï¼šç¡®è®¤é…é¢é…ç½®å·²æ­£ç¡®åˆå§‹åŒ–

```bash
# 1. æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
cd projects/api
npx tsx scripts/init-quota-config.ts

# 2. éªŒè¯è¾“å‡º
# åº”è¯¥çœ‹åˆ°è¡¨æ ¼æ˜¾ç¤º free å’Œ premium ä¸¤æ¡è®°å½•
```

### äºŒã€åç«¯ API æµ‹è¯•

#### 2.1 é…é¢æŸ¥è¯¢ API

```bash
# è·å–å½“å‰ç”¨æˆ·é…é¢ä¿¡æ¯
curl http://localhost:3000/api/users/me/quota \
  -H "Cookie: better-auth.session_token=YOUR_TOKEN"

# é¢„æœŸå“åº”ï¼š
{
  "success": true,
  "data": {
    "tier": "free",
    "dailyLimit": 2,
    "usedToday": 0,
    "remainingToday": 2,
    "maxArticleWords": 1000
  }
}
```

#### 2.2 å­—æ•°é™åˆ¶æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹ 1ï¼šå…è´¹ç”¨æˆ· - è¾¹ç•Œå€¼ï¼ˆ1000 è¯ï¼‰**

```bash
# ç”Ÿæˆæ°å¥½ 1000 è¯çš„æ–‡æœ¬
echo "word " | awk '{for(i=1;i<=1000;i++)print}' | tr '\n' ' ' > test-1000.txt

# æäº¤åˆ†æ
curl -X POST http://localhost:3000/api/text/analyze \
  -H "Content-Type: application/json" \
  -H "Cookie: better-auth.session_token=YOUR_TOKEN" \
  -d '{"content": "...1000è¯å†…å®¹..."}'

# âœ… é¢„æœŸï¼š200 æˆåŠŸå“åº”
```

**æµ‹è¯•ç”¨ä¾‹ 2ï¼šå…è´¹ç”¨æˆ· - è¶…é™ï¼ˆ1001 è¯ï¼‰**

```bash
# ç”Ÿæˆ 1001 è¯çš„æ–‡æœ¬
echo "word " | awk '{for(i=1;i<=1001;i++)print}' | tr '\n' ' ' > test-1001.txt

# æäº¤åˆ†æ
curl -X POST http://localhost:3000/api/text/analyze \
  -H "Content-Type: application/json" \
  -H "Cookie: better-auth.session_token=YOUR_TOKEN" \
  -d '{"content": "...1001è¯å†…å®¹..."}'

# âŒ é¢„æœŸï¼š400 é”™è¯¯
{
  "success": false,
  "error": "æ‚¨çš„æ–‡ç« æœ‰ 1001 è¯ï¼Œè¶…è¿‡äº†å…è´¹ç‰ˆ 1000 è¯çš„é™åˆ¶...",
  "wordCount": 1001,
  "maxWords": 1000,
  "tier": "free"
}
```

#### 2.3 æ¯æ—¥æ¬¡æ•°é™åˆ¶æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹ï¼šå…è´¹ç”¨æˆ·è¾¾åˆ°æ¯æ—¥é™åˆ¶**

```bash
# ç¬¬ 1 æ¬¡åˆ†æ - âœ… æˆåŠŸ
curl -X POST http://localhost:3000/api/text/analyze ...

# ç¬¬ 2 æ¬¡åˆ†æ - âœ… æˆåŠŸ
curl -X POST http://localhost:3000/api/text/analyze ...

# ç¬¬ 3 æ¬¡åˆ†æ - âŒ åº”è¿”å› 429 é”™è¯¯
{
  "success": false,
  "error": "æ‚¨å·²è¾¾åˆ°æ¯æ—¥ 2 æ¬¡æ–‡ç« åˆ†æçš„é™åˆ¶ï¼Œè¯·å‡çº§è®¢é˜…æˆ–æ˜å¤©å†è¯•",
  "quota": {
    "tier": "free",
    "dailyLimit": 2,
    "usedToday": 2,
    "remainingToday": 0
  }
}
```

### ä¸‰ã€å‰ç«¯åŠŸèƒ½æµ‹è¯•

#### 3.1 é…é¢ä¿¡æ¯æ˜¾ç¤º

**æµ‹è¯•æ­¥éª¤**ï¼š

1. ç™»å½•ç³»ç»Ÿå¹¶è¿›å…¥ Dashboard
2. æŸ¥çœ‹é¡µé¢é¡¶éƒ¨çš„é…é¢å¡ç‰‡

**éªŒè¯ç‚¹**ï¼š

- âœ… æ˜¾ç¤ºè®¢é˜…ç­‰çº§ï¼ˆå…è´¹ç‰ˆ/ä¸“ä¸šç‰ˆï¼‰
- âœ… æ˜¾ç¤ºæ¯æ—¥å‰©ä½™æ¬¡æ•°ï¼ˆå¦‚ï¼šå‰©ä½™ 2 / 2 æ¬¡ï¼‰
- âœ… æ˜¾ç¤ºå•ç¯‡å­—æ•°é™åˆ¶ï¼ˆå¦‚ï¼šå•ç¯‡æœ€å¤š 1,000 è¯ï¼‰
- âœ… è¿›åº¦æ¡æ­£ç¡®æ˜¾ç¤ºä½¿ç”¨æ¯”ä¾‹
- âœ… å…è´¹ç”¨æˆ·æ˜¾ç¤º"å‡çº§åˆ°ä¸“ä¸šç‰ˆ"æŒ‰é’®

#### 3.2 å®æ—¶å­—æ•°ç»Ÿè®¡

**æµ‹è¯•æ­¥éª¤**ï¼š

1. åœ¨æ–‡ç« è¾“å…¥æ¡†ä¸­ç²˜è´´æˆ–è¾“å…¥æ–‡æœ¬
2. è§‚å¯Ÿåº•éƒ¨çš„å­—æ•°ç»Ÿè®¡

**éªŒè¯ç‚¹**ï¼š

- âœ… å®æ—¶æ›´æ–°å­—æ•°æ˜¾ç¤ºï¼ˆå¦‚ï¼šå­—æ•°: 500 / 1,000ï¼‰
- âœ… è¶…é™æ—¶å­—æ•°å˜çº¢è‰²å¹¶æ˜¾ç¤º"è¶…å‡º XXX è¯"
- âœ… è¶…é™æ—¶"åˆ†ææ–‡ç« "æŒ‰é’®è¢«ç¦ç”¨

#### 3.3 å‰ç«¯å­—æ•°éªŒè¯

**æµ‹è¯•æ­¥éª¤**ï¼š

1. è¾“å…¥è¶…è¿‡ 1000 è¯çš„æ–‡ç« ï¼ˆå…è´¹ç”¨æˆ·ï¼‰
2. ç‚¹å‡»"åˆ†ææ–‡ç« "æŒ‰é’®

**éªŒè¯ç‚¹**ï¼š

- âœ… æŒ‰é’®åº”è¯¥æ˜¯ç¦ç”¨çŠ¶æ€ï¼ˆæ— æ³•ç‚¹å‡»ï¼‰
- âœ… å¦‚æœé€šè¿‡å…¶ä»–æ–¹å¼è§¦å‘ï¼Œåº”å¼¹å‡ºå‡çº§å¼•å¯¼å¼¹çª—

#### 3.4 å‡çº§å¼•å¯¼å¼¹çª—

**æµ‹è¯•åœºæ™¯ 1ï¼šå­—æ•°è¶…é™**

1. è¾“å…¥ 1001 è¯æ–‡ç« 
2. å°è¯•åˆ†æ

**éªŒè¯ç‚¹**ï¼š

- âœ… å¼¹å‡ºæ¨¡æ€æ¡†æ ‡é¢˜ï¼š"æ–‡ç« å­—æ•°è¶…å‡ºé™åˆ¶"
- âœ… æ˜¾ç¤ºå½“å‰å­—æ•°å’Œé™åˆ¶ï¼ˆå¦‚ï¼š1001 è¯ vs 1000 è¯é™åˆ¶ï¼‰
- âœ… å¯¹æ¯”å…è´¹ç‰ˆå’Œä¸“ä¸šç‰ˆåŠŸèƒ½
- âœ… "ç«‹å³å‡çº§"æŒ‰é’®è·³è½¬åˆ° pricing åŒºåŸŸ
- âœ… "ç¨åå†è¯´"æŒ‰é’®å…³é—­å¼¹çª—

**æµ‹è¯•åœºæ™¯ 2ï¼šæ¬¡æ•°è¶…é™**

1. å…è´¹ç”¨æˆ·åˆ†æç¬¬ 3 ç¯‡æ–‡ç« 
2. åç«¯è¿”å› 429 é”™è¯¯

**éªŒè¯ç‚¹**ï¼š

- âœ… å¼¹å‡ºæ¨¡æ€æ¡†æ ‡é¢˜ï¼š"ä»Šæ—¥åˆ†ææ¬¡æ•°å·²ç”¨å®Œ"
- âœ… æç¤ºå·²è¾¾åˆ°æ¯æ—¥ 2 æ¬¡é™åˆ¶
- âœ… æ˜¾ç¤ºå‡çº§å¼•å¯¼

#### 3.5 é…é¢è‡ªåŠ¨åˆ·æ–°

**æµ‹è¯•æ­¥éª¤**ï¼š

1. è®°å½•å½“å‰é…é¢ï¼ˆå¦‚ï¼šå‰©ä½™ 2 / 2 æ¬¡ï¼‰
2. æˆåŠŸåˆ†æä¸€ç¯‡æ–‡ç« 
3. è§‚å¯Ÿé…é¢ä¿¡æ¯

**éªŒè¯ç‚¹**ï¼š

- âœ… é…é¢è‡ªåŠ¨æ›´æ–°ä¸ºï¼ˆå‰©ä½™ 1 / 2 æ¬¡ï¼‰
- âœ… è¿›åº¦æ¡è‡ªåŠ¨æ›´æ–°

### å››ã€ä¸“ä¸šç‰ˆç”¨æˆ·æµ‹è¯•

**å‰ç½®æ¡ä»¶**ï¼šå°†æµ‹è¯•ç”¨æˆ·å‡çº§ä¸º premiumï¼ˆç›´æ¥ä¿®æ”¹æ•°æ®åº“æˆ–é€šè¿‡ç®¡ç†åå°ï¼‰

```sql
-- åœ¨æ•°æ®åº“ä¸­åˆ›å»º premium è®¢é˜…
INSERT INTO subscriptions (user_id, tier, status, started_at)
VALUES (YOUR_USER_ID, 'premium', 'active', NOW());
```

**éªŒè¯ç‚¹**ï¼š

- âœ… é…é¢å¡ç‰‡æ˜¾ç¤º"ä¸“ä¸šç‰ˆ"å’Œçš‡å† å›¾æ ‡
- âœ… æ˜¾ç¤º"å‰©ä½™ 50 / 50 æ¬¡"
- âœ… æ˜¾ç¤º"å•ç¯‡æœ€å¤š 5,000 è¯"
- âœ… å¯ä»¥æäº¤æœ€å¤š 5000 è¯çš„æ–‡ç« 
- âœ… æäº¤ 5001 è¯æ—¶è¢«æ‹’ç»
- âœ… ä¸æ˜¾ç¤º"å‡çº§"æŒ‰é’®

### äº”ã€è¾¹ç•Œæƒ…å†µæµ‹è¯•

#### 5.1 è·¨å¤©é…é¢é‡ç½®

- æµ‹è¯•ç¬¬äºŒå¤© 00:00 åé…é¢æ˜¯å¦é‡ç½®ä¸ºæ»¡é¢

#### 5.2 å¹¶å‘è¯·æ±‚

- æµ‹è¯•åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚æ˜¯å¦ä¼šç»•è¿‡é™åˆ¶

#### 5.3 æœªç™»å½•ç”¨æˆ·

- æµ‹è¯•æœªç™»å½•è®¿é—®é…é¢ API è¿”å› 401

#### 5.4 é…ç½®ç¼ºå¤±

- æµ‹è¯•æ•°æ®åº“ä¸­åˆ é™¤é…é¢é…ç½®åçš„é”™è¯¯å¤„ç†

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•æµç¨‹

### 1. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨åç«¯ï¼ˆTerminal 1ï¼‰
cd projects/api
npm run dev

# å¯åŠ¨å‰ç«¯ï¼ˆTerminal 2ï¼‰
cd projects/client
npm run dev
```

### 2. å‡†å¤‡æµ‹è¯•æ–‡æœ¬

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ç”Ÿæˆæµ‹è¯•æ–‡æœ¬
// ç”Ÿæˆ 1000 è¯
console.log("word ".repeat(1000).trim());

// ç”Ÿæˆ 1001 è¯
console.log("word ".repeat(1001).trim());

// ç”Ÿæˆ 5000 è¯
console.log("word ".repeat(5000).trim());

// ç”Ÿæˆ 5001 è¯
console.log("word ".repeat(5001).trim());
```

### 3. æ‰§è¡Œå‰ç«¯æµ‹è¯•

1. è®¿é—® http://localhost:5173
2. ç™»å½•æµ‹è¯•è´¦å·
3. è¿›å…¥ Dashboard
4. ä¾æ¬¡æµ‹è¯•ï¼š
   - âœ… é…é¢ä¿¡æ¯æ˜¾ç¤º
   - âœ… å®æ—¶å­—æ•°ç»Ÿè®¡
   - âœ… 1000 è¯è¾¹ç•Œæµ‹è¯•
   - âœ… 1001 è¯è¶…é™æµ‹è¯•
   - âœ… åˆ†æ 2 æ¬¡åçš„é™åˆ¶
   - âœ… å‡çº§å¼¹çª—æ˜¾ç¤º

### 4. éªŒè¯åç«¯æ—¥å¿—

è§‚å¯Ÿç»ˆç«¯è¾“å‡ºï¼Œç¡®è®¤ï¼š

- é…é¢æ£€æŸ¥é€»è¾‘æ­£ç¡®æ‰§è¡Œ
- å­—æ•°éªŒè¯æ­£ç¡®æ‹¦æˆª
- æ•°æ®åº“æŸ¥è¯¢æ— é”™è¯¯

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šé…é¢ä¿¡æ¯ä¸æ˜¾ç¤º

**æ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥ `GET /api/users/me/quota` è¿”å›æ•°æ®
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
3. ç¡®è®¤ç”¨æˆ·å·²ç™»å½•

### é—®é¢˜ 2ï¼šå­—æ•°ç»Ÿè®¡ä¸å‡†ç¡®

**åŸå› **ï¼šå‰åç«¯å­—æ•°è®¡ç®—é€»è¾‘ä¸ä¸€è‡´
**è§£å†³**ï¼šä¸¤ç«¯éƒ½ä½¿ç”¨ `text.split(/\s+/).filter(w => w.trim().length > 0).length`

### é—®é¢˜ 3ï¼šé…é¢ä¸åˆ·æ–°

**æ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥æ˜¯å¦è°ƒç”¨äº† `refetchQuota()`
2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸ
3. æŸ¥çœ‹ React DevTools ä¸­çš„çŠ¶æ€æ›´æ–°

### é—®é¢˜ 4ï¼šæ¨¡æ€æ¡†ä¸æ˜¾ç¤º

**æ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥ `upgradeModalOpen` çŠ¶æ€
2. æ£€æŸ¥é”™è¯¯å¤„ç†é€»è¾‘æ˜¯å¦æ­£ç¡®è§¦å‘
3. ç¡®è®¤ Dialog ç»„ä»¶æ­£ç¡®å¯¼å…¥
