# 注册页面 Tab 功能实现总结

> **📘 文档类型**：功能实现  
> **🎯 适合读者**：前后端开发者  
> **⏱️ 预计阅读**：10 分钟  
> **📅 最后更新**：2025-01-15  
> **🔗 相关文档**：[AUTH_IMPLEMENTATION.md](./AUTH_IMPLEMENTATION.md) · [ARCHITECTURE.md](./ARCHITECTURE.md)

---

## 📋 任务目标

为 `register.tsx` 添加 Tab 功能，实现两种注册方式：

1. **手机号注册**：用户名、手机号、验证码、邮箱（可选）
2. **邮箱注册**：用户名、邮箱、密码、确认密码

参考 `login.tsx` 的 Tab 实现风格，保持 UI 一致性。

---

## ✅ 实现内容

### 1. 前端实现 (`projects/client/src/pages/register.tsx`)

#### 核心改动：

- **拆分 Schema**：将单一的 `registerSchema` 拆分为 `phoneRegisterSchema` 和 `emailRegisterSchema`
- **双表单管理**：使用 `phoneForm` 和 `emailForm` 分别管理两个 Tab 的表单状态
- **独立提交逻辑**：
  - `onPhoneSubmit`：手机号验证 → 完成注册（调用 `complete-registration` API）
  - `onEmailSubmit`：直接使用 Better Auth 的 `signUp.email` 注册
- **Tab 切换**：使用 `activeTab` 状态管理 Tab 切换

#### 关键代码：

```typescript
// 手机号注册
const onPhoneSubmit = async (formData: PhoneRegisterForm) => {
  // 1. 验证手机号
  await authClient.phoneNumber.verify({ phoneNumber, code });
  // 2. 完成注册（不需要密码）
  await apiClient.api.auth["complete-registration"].$patch({
    json: { name, email },
  });
};

// 邮箱注册
const onEmailSubmit = async (formData: EmailRegisterForm) => {
  await signUp.email({
    email: formData.email,
    password: formData.password,
    name: formData.username,
    callbackURL: window.location.origin + "/login", // ✅ 关键配置
  });
};
```

---

### 2. 后端调整 (`projects/api/src/route/auth.route.ts`)

#### 问题：

手机号注册不需要密码，但 `complete-registration` API 要求 `password` 字段必填。

#### 解决方案：

将 `password` 改为可选：

```typescript
const updateProfileSchema = z.object({
  name: z.string().min(2).max(20),
  email: z.string().email().optional(),
  password: z.string().min(6).max(20).optional(), // ✅ 改为可选
});
```

#### 当前实现状态：

**手机号注册无需密码**：在 `auth.service.ts` 的 `completeRegistration` 函数中，密码设置逻辑已被注释（第 152-161 行），因为项目决定手机号注册时不需要设置密码。

> **💡 如需启用**：如果将来需要支持手机号注册后设置密码，可以取消 `auth.service.ts` 中相关代码的注释。

---

## 🔧 邮箱验证功能配置

### 问题 1：`sendVerificationEmail` 没有被调用

#### 原因：

`sendVerificationEmail` 配置位置错误，应该在独立的 `emailVerification` 块中，而不是 `emailAndPassword` 内部。

#### 解决方案 (`projects/api/src/auth/auth.ts`)：

```typescript
// ❌ 错误位置
emailAndPassword: {
  sendVerificationEmail: async ({ user, url, token }) => { ... }
}

// ✅ 正确位置
emailVerification: {
  sendVerificationEmail: async ({ user, url, token }) => {
    console.log(`📧 发送验证邮件到 ${user.email}: ${url}`);
    // TODO: 实现邮件发送逻辑
  },
  sendOnSignUp: true, // 🔑 关键：注册时自动发送验证邮件
  autoSignInAfterVerification: false,
  expiresIn: 86400, // 24 小时
},
```

---

### 问题 2：验证链接重定向到后端返回 404

#### 现象：

```
GET /api/auth/verify-email?token=... 302 FOUND  ← 验证成功
GET / 404 Not Found                              ← 重定向错误
```

#### 原因：

默认的 `callbackURL=/` 是后端路径，验证后重定向到后端的根路径（不存在）。

#### 解决方案：

前端注册时指定 `callbackURL`：

```typescript
const { error } = await signUp.email({
  email: formData.email,
  password: formData.password,
  name: formData.username,
  callbackURL: window.location.origin + "/login", // ✅ 重定向到前端
});
```

**优势**：`window.location.origin` 会自动适配环境：

- 本地：`http://localhost:5173/login`
- 生产：`https://yourdomain.com/login`

---

### 问题 3：`signUp.email` 是否支持 `name` 参数？

#### 答案：

✅ **支持！** Better Auth 的 `signUp.email` 方法支持 `name` 参数。

#### 验证：

- ✅ TypeScript linter 没有报错
- ✅ Better Auth 官方文档确认
- ✅ `api-client.ts` 示例代码包含此参数

```typescript
// Better Auth 会自动将 name 保存到 users 表
await signUp.email({
  email: "user@example.com",
  password: "password123",
  name: "User Name", // ✅ 有效参数
});
```

---

## 🚀 邮箱验证工作流程

### 完整流程：

```
用户注册
   ↓
Better Auth 创建用户（emailVerified = false）
   ↓
Better Auth 生成 token 和验证链接
   ↓
调用 sendVerificationEmail 钩子 ← 你只需实现邮件发送
   ↓
用户收到邮件，点击验证链接
   ↓
Better Auth 自动验证 token ← 框架处理
   ↓
Better Auth 更新 emailVerified = true ← 框架处理
   ↓
重定向到前端登录页（callbackURL）
```

### 关键点：

1. **`sendVerificationEmail` 是钩子函数**：你只需发送邮件，验证逻辑 Better Auth 自动处理
2. **`url` 参数已是完整链接**：包含 token 和 callbackURL，直接发送给用户即可
3. **用户点击链接后**：Better Auth 自动验证并更新数据库

---

## 📦 部署到 Cloudflare 的配置

### 前端配置：

✅ **无需修改**！`callbackURL: window.location.origin + "/login"` 会自动适配。

### 后端配置：

#### 需要更新 `trustedOrigins`：

```typescript
// projects/api/src/auth/auth.ts
trustedOrigins: [
  "http://localhost:5173", // 本地开发
  "https://yourdomain.com", // 👈 添加生产域名
  "https://vocab-master.pages.dev", // 👈 Cloudflare Pages
],
```

#### 需要配置 Cloudflare 环境变量：

```bash
BETTER_AUTH_URL=https://api.yourdomain.com
BETTER_AUTH_SECRET=your-production-secret
DATABASE_URL=postgresql://...
```

---

## 📝 类型安全问题

### 问题：

`sendVerificationEmail` 参数类型报错（`user: any`）。

### 解决方案：

使用具体类型定义：

```typescript
sendVerificationEmail: async ({
  user,
  url,
  token,
}: {
  user: { id: string | number; email: string; name: string };
  url: string;
  token: string;
}) => { ... }
```

**注意**：`id: string | number` 考虑到项目使用了自增 ID（`useNumberId: true`）。

---

## 🎯 最终效果

### Tab 1: 手机号注册

- 字段：用户名、手机号、验证码、邮箱（可选）
- 无需密码
- 注册后直接跳转到首页

### Tab 2: 邮箱注册

- 字段：用户名、邮箱、密码、确认密码
- 注册后发送验证邮件
- 提示用户查收邮件并验证
- 跳转到登录页

### 邮箱验证流程

- 控制台打印验证链接（开发阶段）
- 用户点击链接 → 自动验证 → 跳转到登录页
- 将来实现邮件服务后，用户会收到邮件

---

## 📌 待实现功能

- [ ] 集成邮件发送服务（Resend、SendGrid 等）
- [ ] 生产环境添加前端域名到 `trustedOrigins`
- [ ] 邮箱验证后的提示页面优化
- [ ] 手机号注册后设置密码的流程（可选）

---

## 🔗 相关文件

- **前端**：`projects/client/src/pages/register.tsx`
- **后端路由**：`projects/api/src/route/auth.route.ts`
- **认证配置**：`projects/api/src/auth/auth.ts`
- **API 客户端**：`projects/client/src/lib/api-client.ts`

---

_文档生成时间：2025-11-02_
