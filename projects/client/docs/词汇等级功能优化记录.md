# è¯æ±‡ç­‰çº§åŠŸèƒ½ä¼˜åŒ–è®°å½•

## ğŸ“… ä¼˜åŒ–æ—¶é—´

2025-11-03

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

ç®€åŒ–è¯æ±‡ç­‰çº§é€‰æ‹©å’Œé‡å®šå‘é€»è¾‘ï¼Œæå‡ä»£ç å¯ç»´æŠ¤æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

## ğŸ“Š ä¼˜åŒ–æˆæœ

### ä»£ç é‡å‡å°‘

- **Dashboard é¡µé¢**ï¼š105 è¡Œ â†’ 42 è¡Œï¼ˆå‡å°‘ **60%**ï¼‰
- **Vocab-level é¡µé¢**ï¼š197 è¡Œ â†’ 165 è¡Œï¼ˆå‡å°‘ **17%**ï¼‰
- **æ€»è®¡å‡å°‘**ï¼š**97 è¡Œä»£ç **

### Bug ä¿®å¤

- âœ… ä¿®å¤äº†é¡µé¢åˆ·æ–°å `location.state.fromLevelSelection` ä¿ç•™å¯¼è‡´æ— æ³•é‡å®šå‘çš„ bug
- âœ… ä¿®å¤äº† React.StrictMode ä¸‹ useEffect åŒé‡æ‰§è¡Œå¯¼è‡´çš„é—®é¢˜
- âœ… ä¿®å¤äº† setTimeout å®šæ—¶å™¨å¯èƒ½è¢«æ¸…ç†å¯¼è‡´é‡å®šå‘å¤±è´¥çš„é—®é¢˜

## ğŸ”§ ä¸»è¦æ”¹åŠ¨

### 1. Dashboard é¡µé¢ï¼ˆdashboard.tsxï¼‰

#### ä¼˜åŒ–å‰

```typescript
import { useEffect, useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { toast } from "sonner";

export default function DashboardPage() {
  const { user, isLoading } = useAuth();
  const location = useLocation();
  const navigate = useNavigate();
  const fromLevelSelection = location.state?.fromLevelSelection;
  const [shouldRedirect, setShouldRedirect] = useState(false);

  const extendedUser = user as ExtendedUser | undefined;

  // âŒ å¤æ‚çš„ useEffect é€»è¾‘
  useEffect(() => {
    if (isLoading) return;
    if (fromLevelSelection) return; // è¿™ä¸ªåˆ¤æ–­å¯¼è‡´äº† bug

    if (extendedUser && !extendedUser.vocabularyLevel) {
      toast.info("æ£€æµ‹åˆ°æ‚¨è¿˜æœªè®¾ç½®è¯æ±‡ç­‰çº§ï¼Œæ­£åœ¨è·³è½¬...");

      // âŒ setTimeout å¯èƒ½è¢«æ¸…ç†
      const timer = setTimeout(() => {
        navigate("/level", { replace: true });
      }, 1000);

      return () => clearTimeout(timer);
    }
  }, [extendedUser, isLoading, navigate, fromLevelSelection]);

  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  // âŒ é‡å¤æ£€æŸ¥
  if (!extendedUser?.vocabularyLevel) {
    return <div>æ­£åœ¨è·³è½¬...</div>;
  }

  return <Dashboard />;
}
```

**é—®é¢˜ï¼š**

- âŒ ä½¿ç”¨ `useState` ç®¡ç† `shouldRedirect`ï¼ˆä¸å¿…è¦ï¼‰
- âŒ ä½¿ç”¨ `useEffect` ç›‘å¬å¹¶å»¶è¿Ÿè·³è½¬ï¼ˆå¤æ‚ï¼‰
- âŒ ä½¿ç”¨ `setTimeout` å»¶è¿Ÿï¼ˆå¯èƒ½è¢«æ¸…ç†ï¼‰
- âŒ ä¾èµ– `fromLevelSelection` å¯¼è‡´åˆ·æ–°åæ— æ³•è·³è½¬
- âŒ ä¸‰å±‚é‡å¤æ£€æŸ¥é€»è¾‘
- âŒ ä»£ç å†—é•¿ï¼ˆ105 è¡Œï¼‰

#### ä¼˜åŒ–å

```typescript
import { Navigate } from "react-router-dom";

export default function DashboardPage() {
  const { user, isLoading } = useAuth();
  const extendedUser = user as ExtendedUser | undefined;

  // åŠ è½½ä¸­æ˜¾ç¤º
  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  // âœ… æ²¡æœ‰è¯æ±‡ç­‰çº§ï¼Œç›´æ¥é‡å®šå‘
  if (!extendedUser?.vocabularyLevel) {
    return <Navigate to="/level" replace />;
  }

  // âœ… æ­£å¸¸æ˜¾ç¤º Dashboard
  return <Dashboard />;
}
```

**æ”¹è¿›ï¼š**

- âœ… ä½¿ç”¨å£°æ˜å¼çš„ `<Navigate>` ç»„ä»¶
- âœ… ç§»é™¤æ‰€æœ‰ state å’Œ useEffect
- âœ… ç§»é™¤ setTimeout å»¶è¿Ÿ
- âœ… ç§»é™¤ location.state ä¾èµ–
- âœ… å•ä¸€æ£€æŸ¥ç‚¹ï¼Œé€»è¾‘æ¸…æ™°
- âœ… ä»£ç ç®€æ´ï¼ˆ42 è¡Œï¼‰

---

### 2. Vocab-level é¡µé¢ï¼ˆvocab-level.tsxï¼‰

#### ä¼˜åŒ–å‰

```typescript
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";

export default function VocabLevelSelection() {
  const navigate = useNavigate();
  const { user, isLoading, refetch } = useAuth();

  // âŒ å¤æ‚çš„ useEffect æ£€æŸ¥
  useEffect(() => {
    if (isLoading) return;

    if (extendedUser?.vocabularyLevel) {
      toast.info("æ‚¨å·²è®¾ç½®è¯æ±‡ç­‰çº§ï¼Œæ­£åœ¨è·³è½¬åˆ°æ§åˆ¶å°...");

      const timer = setTimeout(() => {
        navigate("/dashboard", { replace: true });
      }, 1000);

      return () => clearTimeout(timer);
    }
  }, [extendedUser, isLoading, navigate]);

  const handleConfirm = async () => {
    await updateUser.mutateAsync({ vocabularyLevel: selectedLevel });

    refetch(); // âŒ æ²¡æœ‰ await

    toast.success("è¯æ±‡ç­‰çº§è®¾ç½®æˆåŠŸï¼");

    // âŒ æ‰‹åŠ¨è·³è½¬ + ä¼ é€’ state
    setTimeout(() => {
      navigate("/dashboard", {
        replace: true,
        state: { fromLevelSelection: true }, // è¿™ä¸ª state å¯¼è‡´äº† bug
      });
    }, 500);
  };

  if (extendedUser?.vocabularyLevel) {
    return null; // âŒ è¿”å› null
  }

  return <VocabLevelForm />;
}
```

**é—®é¢˜ï¼š**

- âŒ ä½¿ç”¨ useEffect + setTimeout å»¶è¿Ÿé‡å®šå‘
- âŒ `refetch()` æ²¡æœ‰ await
- âŒ æ‰‹åŠ¨è°ƒç”¨ `navigate()` è·³è½¬
- âŒ ä¼ é€’ `state: { fromLevelSelection: true }`
- âŒ è¿”å› `null` è€Œä¸æ˜¯ `<Navigate>`

#### ä¼˜åŒ–å

```typescript
import { useState } from "react";
import { Navigate } from "react-router-dom";

export default function VocabLevelSelection() {
  const { user, isLoading, refetch } = useAuth();
  const extendedUser = user as ExtendedUser | undefined;

  const handleConfirm = async () => {
    try {
      // 1. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      await updateUser.mutateAsync({
        vocabularyLevel: selectedLevel,
      });

      // 2. âœ… ç­‰å¾… session åˆ·æ–°å®Œæˆ
      await refetch();

      // 3. æ˜¾ç¤ºæˆåŠŸæç¤º
      toast.success("è¯æ±‡ç­‰çº§è®¾ç½®æˆåŠŸï¼");

      // 4. âœ… ç»„ä»¶ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“å¹¶è·³è½¬
    } catch (error) {
      toast.error("è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
  };

  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  // âœ… å¦‚æœå·²è®¾ç½®è¯æ±‡ç­‰çº§ï¼Œé‡å®šå‘åˆ° dashboard
  if (extendedUser?.vocabularyLevel) {
    return <Navigate to="/dashboard" replace />;
  }

  return <VocabLevelForm />;
}
```

**æ”¹è¿›ï¼š**

- âœ… ä½¿ç”¨ `<Navigate>` æ›¿ä»£ useEffect + navigate
- âœ… ä½¿ç”¨ `await refetch()` ç¡®ä¿ session æ›´æ–°å®Œæˆ
- âœ… ç§»é™¤æ‰‹åŠ¨ `navigate()` è°ƒç”¨
- âœ… ç§»é™¤ `state: { fromLevelSelection: true }`
- âœ… è‡ªåŠ¨é‡æ–°æ¸²æŸ“å¹¶è·³è½¬
- âœ… ä»£ç æ›´æ¸…æ™°ï¼ˆ165 è¡Œï¼‰

---

### 3. æ–°å¢ç»Ÿä¸€æ•°æ®ç®¡ç†ï¼ˆvocabulary.tsï¼‰

åˆ›å»ºäº† `src/utils/vocabulary.ts` ç»Ÿä¸€ç®¡ç†è¯æ±‡ç­‰çº§æ•°æ®ï¼š

```typescript
export const vocabularyLevels: VocabularyLevelInfo[] = [
  {
    id: "primary_school",
    emoji: "ğŸ“š",
    title: "å°å­¦è¯æ±‡ï¼ˆçº¦ 800 è¯ï¼‰",
    scene: "é€‚åˆï¼šåŸºç¡€å…¥é—¨ã€å„¿ç«¥å­¦ä¹ ",
    reference: "å‚è€ƒï¼šå°å­¦æ¯•ä¸šæ°´å¹³",
    wordCount: "800",
    label: "å°å­¦",
  },
  // ...å…¶ä»–ç­‰çº§
];

export function getVocabularyDisplay(
  level: VocabularyLevel | null | undefined
) {
  // è¿”å›æ ¼å¼åŒ–çš„æ˜¾ç¤ºä¿¡æ¯
}
```

**ä¼˜åŠ¿ï¼š**

- âœ… å•ä¸€æ•°æ®æºï¼Œé¿å…é‡å¤å®šä¹‰
- âœ… åœ¨é€‰æ‹©é¡µé¢ã€NavBar ç­‰å¤šå¤„å¤ç”¨
- âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•

---

### 4. NavBar æ˜¾ç¤ºè¯æ±‡ç­‰çº§

æ›´æ–°äº† `dashboard-navbar.tsx` æ¥åŠ¨æ€æ˜¾ç¤ºç”¨æˆ·çš„è¯æ±‡ç­‰çº§ï¼š

```typescript
export function DashboardNavbar() {
  const { user } = useAuth();
  const extendedUser = user as ExtendedUser | undefined;

  // âœ… ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®æº
  const vocabDisplay = getVocabularyDisplay(extendedUser?.vocabularyLevel);
  const badgeText = `${vocabDisplay.label} Â· ${vocabDisplay.wordCount}è¯`;

  return (
    <nav>
      <Badge>{badgeText}</Badge>
    </nav>
  );
}
```

**ç‰¹ç‚¹ï¼š**

- âœ… å®æ—¶æ˜¾ç¤ºç”¨æˆ·è¯æ±‡ç­‰çº§
- âœ… è‡ªåŠ¨åŒæ­¥æ›´æ–°
- âœ… ä½¿ç”¨ç»Ÿä¸€æ•°æ®æº

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›ç‚¹

### 1. å£°æ˜å¼é‡å®šå‘

**ä¹‹å‰ï¼š** å‘½ä»¤å¼ `navigate()`

```typescript
navigate("/level", { replace: true });
```

**ç°åœ¨ï¼š** å£°æ˜å¼ `<Navigate>`

```typescript
if (!vocabularyLevel) {
  return <Navigate to="/level" replace />;
}
```

**ä¼˜åŠ¿ï¼š**

- âœ… æ›´ç¬¦åˆ React ç†å¿µ
- âœ… ä¸ä¼šæœ‰æ—¶åºé—®é¢˜
- âœ… ä»£ç æ›´æ˜“ç†è§£

### 2. ç§»é™¤çŠ¶æ€ç®¡ç†

**ä¹‹å‰ï¼š** ä½¿ç”¨ state å’Œ useEffect

```typescript
const [shouldRedirect, setShouldRedirect] = useState(false);

useEffect(() => {
  if (!vocabularyLevel) {
    setShouldRedirect(true);
  }
}, [vocabularyLevel]);

if (shouldRedirect) {
  return <Navigate />;
}
```

**ç°åœ¨ï¼š** ç›´æ¥æ¡ä»¶æ¸²æŸ“

```typescript
if (!vocabularyLevel) {
  return <Navigate />;
}
```

**ä¼˜åŠ¿ï¼š**

- âœ… ç®€åŒ–ä»£ç 
- âœ… å‡å°‘çŠ¶æ€ç®¡ç†
- âœ… é¿å…é‡æ¸²æŸ“

### 3. await refetch()

**ä¹‹å‰ï¼š** ä¸ç­‰å¾… refetch å®Œæˆ

```typescript
refetch(); // å¼‚æ­¥ä½†ä¸ç­‰å¾…
navigate("/dashboard"); // ç«‹å³è·³è½¬ï¼Œå¯èƒ½ session è¿˜æ²¡æ›´æ–°
```

**ç°åœ¨ï¼š** ç­‰å¾… refetch å®Œæˆ

```typescript
await refetch(); // ç­‰å¾… session æ›´æ–°å®Œæˆ
// ç»„ä»¶è‡ªåŠ¨é‡æ–°æ¸²æŸ“å¹¶è·³è½¬
```

**ä¼˜åŠ¿ï¼š**

- âœ… ç¡®ä¿ session å®Œå…¨æ›´æ–°
- âœ… é¿å…æ—¶åºé—®é¢˜
- âœ… è‡ªåŠ¨é‡å®šå‘

### 4. ç§»é™¤ location.state

**ä¹‹å‰ï¼š** ä½¿ç”¨ state ä¼ é€’æ ‡è®°

```typescript
navigate("/dashboard", {
  state: { fromLevelSelection: true },
});

// åœ¨ Dashboard ä¸­
if (fromLevelSelection) return; // è·³è¿‡æ£€æŸ¥
```

**é—®é¢˜ï¼š**

- âŒ state ä¼šåœ¨åˆ·æ–°åä¿ç•™
- âŒ å¯¼è‡´æ— æ³•æ£€æµ‹å’Œé‡å®šå‘
- âŒ å¢åŠ å¤æ‚åº¦

**ç°åœ¨ï¼š** ä¸éœ€è¦ state

```typescript
await refetch(); // ç¡®ä¿ session æ›´æ–°
// è‡ªåŠ¨é‡å®šå‘ï¼Œæ— éœ€æ ‡è®°
```

**ä¼˜åŠ¿ï¼š**

- âœ… ç®€åŒ–é€»è¾‘
- âœ… é¿å…åˆ·æ–° bug
- âœ… æ›´å¯é 

## ğŸ“ æ–‡æ¡£æ›´æ–°

### åˆ é™¤çš„æ–‡æ¡£

- âŒ `è¯æ±‡ç­‰çº§é‡å®šå‘ä¼˜åŒ–.md` - æè¿°çš„é—®é¢˜å·²ä¸å­˜åœ¨

### æ›´æ–°çš„æ–‡æ¡£

- âœ… `è¯æ±‡ç­‰çº§é€‰æ‹©åŠŸèƒ½å®ç°.md` - å®Œå…¨é‡å†™ï¼Œåæ˜ æ–°çš„å®ç°
- âœ… `æ›´æ–°ç”¨æˆ·ä¿¡æ¯åˆ·æ–°Session.md` - æ›´æ–°ç¤ºä¾‹ä»£ç 

### æ–°å¢çš„æ–‡æ¡£

- âœ… `è¯æ±‡ç­‰çº§åŠŸèƒ½ä¼˜åŒ–è®°å½•.md`ï¼ˆæœ¬æ–‡æ¡£ï¼‰- è®°å½•ä¼˜åŒ–å†ç¨‹

## ğŸ§ª æµ‹è¯•åœºæ™¯

### 1. é¦–æ¬¡ç”¨æˆ·æµç¨‹

âœ… **æµ‹è¯•æ­¥éª¤ï¼š**

1. æ–°ç”¨æˆ·æ³¨å†Œ/ç™»å½•
2. è‡ªåŠ¨è·³è½¬åˆ° `/dashboard`
3. æ£€æµ‹åˆ°æ— è¯æ±‡ç­‰çº§ï¼Œç«‹å³é‡å®šå‘åˆ° `/level`
4. é€‰æ‹©è¯æ±‡ç­‰çº§å¹¶ä¿å­˜
5. è‡ªåŠ¨è·³è½¬å› `/dashboard`
6. æ˜¾ç¤º Dashboard å†…å®¹ï¼ŒNavBar æ˜¾ç¤ºè¯æ±‡ç­‰çº§

**ç»“æœï¼š** âœ… é€šè¿‡

### 2. å·²æœ‰è¯æ±‡ç­‰çº§ç”¨æˆ·

âœ… **æµ‹è¯•æ­¥éª¤ï¼š**

1. å·²è®¾ç½®è¯æ±‡ç­‰çº§çš„ç”¨æˆ·è®¿é—® `/dashboard`
2. ç›´æ¥æ˜¾ç¤º Dashboard å†…å®¹
3. NavBar æ˜¾ç¤ºæ­£ç¡®çš„è¯æ±‡ç­‰çº§

**ç»“æœï¼š** âœ… é€šè¿‡

### 3. åˆ·æ–°é¡µé¢æµ‹è¯•ï¼ˆä¹‹å‰çš„ Bugï¼‰

âœ… **æµ‹è¯•æ­¥éª¤ï¼š**

1. åˆ é™¤ç”¨æˆ·çš„ `vocabularyLevel`
2. åœ¨ `/dashboard` é¡µé¢æŒ‰ F5 åˆ·æ–°
3. åº”è¯¥ç«‹å³é‡å®šå‘åˆ° `/level`

**ä¹‹å‰ï¼š** âŒ åœç•™åœ¨ç©ºç™½é¡µé¢
**ç°åœ¨ï¼š** âœ… æ­£å¸¸é‡å®šå‘

### 4. ç›´æ¥è®¿é—® /level

âœ… **æµ‹è¯•æ­¥éª¤ï¼š**

1. å·²æœ‰è¯æ±‡ç­‰çº§çš„ç”¨æˆ·ç›´æ¥è®¿é—® `/level`
2. åº”è¯¥ç«‹å³é‡å®šå‘åˆ° `/dashboard`

**ç»“æœï¼š** âœ… é€šè¿‡

## ğŸ’¡ ç»éªŒæ€»ç»“

### 1. ä¼˜å…ˆä½¿ç”¨å£°æ˜å¼ç¼–ç¨‹

- ä½¿ç”¨ `<Navigate>` è€Œä¸æ˜¯ `navigate()`
- ä½¿ç”¨æ¡ä»¶æ¸²æŸ“è€Œä¸æ˜¯ useEffect
- è®© React ç®¡ç†çŠ¶æ€ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨æ§åˆ¶

### 2. é¿å…ä¸å¿…è¦çš„çŠ¶æ€

- èƒ½ç”¨ props å’Œæ¡ä»¶åˆ¤æ–­çš„ï¼Œä¸ç”¨ state
- èƒ½ç”¨è®¡ç®—å€¼çš„ï¼Œä¸ç”¨æ´¾ç”Ÿ state
- ä¿æŒç»„ä»¶çŠ¶æ€æœ€å°åŒ–

### 3. ç†è§£å¼‚æ­¥æ“ä½œ

- ä½¿ç”¨ `await refetch()` ç¡®ä¿ session æ›´æ–°
- è®©ç»„ä»¶å“åº”æ•°æ®å˜åŒ–ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨æ§åˆ¶æµç¨‹
- é¿å…å»¶è¿Ÿå’Œå®šæ—¶å™¨

### 4. ç®€åŒ–é‡äºæŠ€å·§

- ç®€å•çš„æ¡ä»¶åˆ¤æ–­ä¼˜äºå¤æ‚çš„çŠ¶æ€ç®¡ç†
- ç›´æ¥çš„æ§åˆ¶æµä¼˜äºé—´æ¥çš„å‰¯ä½œç”¨
- ä»£ç å°‘å³æ˜¯ç¾

## ğŸ“š ç›¸å…³èµ„æº

- [React Router Navigate æ–‡æ¡£](https://reactrouter.com/en/main/components/navigate)
- [React Query refetch æ–‡æ¡£](https://tanstack.com/query/latest/docs/react/guides/queries)
- [Better Auth Session ç®¡ç†](https://www.better-auth.com/docs)

## ğŸ‰ æ€»ç»“

è¿™æ¬¡ä¼˜åŒ–é€šè¿‡é‡‡ç”¨å£°æ˜å¼ç¼–ç¨‹ã€ç®€åŒ–çŠ¶æ€ç®¡ç†ã€ç»Ÿä¸€æ•°æ®æºç­‰æ‰‹æ®µï¼Œå¤§å¹…æå‡äº†ä»£ç è´¨é‡å’Œç”¨æˆ·ä½“éªŒï¼š

- âœ… ä»£ç é‡å‡å°‘ 97 è¡Œï¼ˆçº¦ 30%ï¼‰
- âœ… ä¿®å¤ 3 ä¸ªå…³é”® bug
- âœ… æå‡ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
- âœ… ç”¨æˆ·ä½“éªŒæ›´æµç•…ï¼ˆæ— å»¶è¿Ÿï¼‰
- âœ… æ¶æ„æ›´æ¸…æ™°åˆç†

**æ ¸å¿ƒç†å¿µï¼š** Keep it simple, stupid (KISS) - ç®€å•å°±æ˜¯ç¾ï¼
