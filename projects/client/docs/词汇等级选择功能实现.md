# è¯æ±‡ç­‰çº§é€‰æ‹©åŠŸèƒ½å®ç°

## åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·é¦–æ¬¡ç™»å½•åï¼Œå¦‚æœå°šæœªè®¾ç½®è¯æ±‡ç­‰çº§ï¼Œå°†è¢«è‡ªåŠ¨é‡å®šå‘åˆ°è¯æ±‡ç­‰çº§é€‰æ‹©é¡µé¢ `/level`ï¼Œå®Œæˆç­‰çº§é€‰æ‹©åæ‰èƒ½è®¿é—® Dashboardã€‚

## å®ç°ç»†èŠ‚

### 1. æ•°æ®åº“å­—æ®µ

åœ¨ `users` è¡¨ä¸­çš„ `vocabularyLevel` å­—æ®µï¼š

- ç±»å‹ï¼š`vocabularyLevelEnum`
- å¯é€‰ï¼šæ˜¯ï¼ˆé»˜è®¤å€¼ä¸º `null`ï¼‰
- æšä¸¾å€¼ï¼š
  - `primary_school` - å°å­¦è¯æ±‡ï¼ˆçº¦ 800 è¯ï¼‰
  - `middle_school` - åˆä¸­è¯æ±‡ï¼ˆçº¦ 1,600 è¯ï¼‰
  - `high_school` - é«˜ä¸­è¯æ±‡ï¼ˆçº¦ 3,500 è¯ï¼‰
  - `cet4` - å¤§å­¦å››çº§ï¼ˆçº¦ 4,500 è¯ï¼‰
  - `cet6` - å¤§å­¦å…­çº§ï¼ˆçº¦ 6,000 è¯ï¼‰
  - `ielts_toefl` - é›…æ€æ‰˜ç¦ï¼ˆçº¦ 8,000+ è¯ï¼‰

### 2. Better Auth é…ç½®

åç«¯ `projects/api/src/auth/auth.ts` ä¸­å·²é…ç½® `additionalFields`ï¼Œä½¿ `vocabularyLevel` è‡ªåŠ¨åŒ…å«åœ¨ session ä¸­ï¼š

```typescript
vocabularyLevel: {
  type: "string",
  required: false,
}
```

### 3. å‰ç«¯ç±»å‹å®šä¹‰

**æ–‡ä»¶ï¼š**`projects/client/src/lib/api-client.ts`

å¯¼å‡ºäº† `ExtendedUser` ç±»å‹ï¼ŒåŒ…å«æ‰€æœ‰è‡ªå®šä¹‰å­—æ®µï¼š

```typescript
export type ExtendedUser = {
  // ...æ ‡å‡†å­—æ®µ
  vocabularyLevel?:
    | "primary_school"
    | "middle_school"
    | "high_school"
    | "cet4"
    | "cet6"
    | "ielts_toefl"
    | null;
  // ...å…¶ä»–æ‰©å±•å­—æ®µ
};
```

### 4. è¯æ±‡ç­‰çº§æ•°æ®ç®¡ç†

**æ–‡ä»¶ï¼š**`projects/client/src/utils/vocabulary.ts`

ç»Ÿä¸€ç®¡ç†æ‰€æœ‰è¯æ±‡ç­‰çº§çš„é…ç½®æ•°æ®ï¼š

```typescript
export const vocabularyLevels: VocabularyLevelInfo[] = [
  {
    id: "primary_school",
    emoji: "ğŸ“š",
    title: "å°å­¦è¯æ±‡ï¼ˆçº¦ 800 è¯ï¼‰",
    scene: "é€‚åˆï¼šåŸºç¡€å…¥é—¨ã€å„¿ç«¥å­¦ä¹ ",
    reference: "å‚è€ƒï¼šå°å­¦æ¯•ä¸šæ°´å¹³",
    wordCount: "800",
    label: "å°å­¦",
  },
  // ...å…¶ä»–ç­‰çº§
];

// è·å–è¯æ±‡ç­‰çº§æ˜¾ç¤ºä¿¡æ¯ï¼ˆç”¨äº Badgeï¼‰
export function getVocabularyDisplay(
  level: VocabularyLevel | null | undefined
) {
  // ...
}
```

**ä¼˜åŠ¿ï¼š**

- âœ… å•ä¸€æ•°æ®æºï¼Œé¿å…é‡å¤å®šä¹‰
- âœ… åœ¨é€‰æ‹©é¡µé¢å’Œ NavBar ä¸­å¤ç”¨
- âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•

### 5. Dashboard é‡å®šå‘é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰

**æ–‡ä»¶ï¼š**`projects/client/src/pages/dashboard.tsx`

```typescript
export default function DashboardPage() {
  const { user, isLoading } = useAuth();
  const extendedUser = user as ExtendedUser | undefined;

  // åŠ è½½ä¸­æ˜¾ç¤º
  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div>åŠ è½½ä¸­...</div>
      </div>
    );
  }

  // æ²¡æœ‰è¯æ±‡ç­‰çº§ï¼Œç›´æ¥é‡å®šå‘åˆ°è®¾ç½®é¡µé¢
  if (!extendedUser?.vocabularyLevel) {
    return <Navigate to="/level" replace />;
  }

  // æ­£å¸¸æ˜¾ç¤º Dashboard å†…å®¹
  return (
    <div className="min-h-screen bg-background">
      <DashboardNavbar />
      <main>
        <StatsCards />
        <NewReadingCard />
        <RecentActivities />
      </main>
    </div>
  );
}
```

**å…³é”®æ”¹è¿›ï¼š**

- âœ… ä½¿ç”¨å£°æ˜å¼çš„ `<Navigate>` ç»„ä»¶
- âœ… ç§»é™¤å¤æ‚çš„ useEffect å’Œ state ç®¡ç†
- âœ… ç§»é™¤ setTimeout å»¶è¿Ÿè·³è½¬
- âœ… ä»£ç ä» 105 è¡Œå‡å°‘åˆ° 42 è¡Œï¼ˆç®€åŒ– 60%ï¼‰
- âœ… é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£

### 6. è¯æ±‡ç­‰çº§é€‰æ‹©é¡µé¢ï¼ˆç®€åŒ–ç‰ˆï¼‰

**æ–‡ä»¶ï¼š**`projects/client/src/pages/vocab-level.tsx`

```typescript
export default function VocabLevelSelection() {
  const [selectedLevel, setSelectedLevel] = useState<VocabularyLevel | "">("");
  const updateUser = useUpdateUser();
  const { user, isLoading, refetch } = useAuth();
  const extendedUser = user as ExtendedUser | undefined;

  const handleConfirm = async () => {
    if (!selectedLevel) return;

    try {
      // 1. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      await updateUser.mutateAsync({
        vocabularyLevel: selectedLevel,
      });

      // 2. åˆ·æ–° sessionï¼ˆç­‰å¾…å®Œæˆï¼‰
      await refetch();

      // 3. æ˜¾ç¤ºæˆåŠŸæç¤º
      toast.success("è¯æ±‡ç­‰çº§è®¾ç½®æˆåŠŸï¼");

      // 4. ç»„ä»¶ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“ï¼Œæ£€æµ‹åˆ°æœ‰ vocabularyLevel åä¼šè‡ªåŠ¨è·³è½¬
    } catch (error) {
      toast.error("è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
  };

  // åŠ è½½ä¸­
  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  // å¦‚æœå·²è®¾ç½®è¯æ±‡ç­‰çº§ï¼Œé‡å®šå‘åˆ° dashboard
  if (extendedUser?.vocabularyLevel) {
    return <Navigate to="/dashboard" replace />;
  }

  // æ˜¾ç¤ºé€‰æ‹©ç•Œé¢
  return (
    <div className="min-h-screen bg-background">
      <LandingNavbar />
      <div className="container mx-auto">
        {/* ä½¿ç”¨ vocabularyLevels ç»Ÿä¸€æ•°æ® */}
        <RadioGroup value={selectedLevel} onValueChange={setSelectedLevel}>
          {vocabularyLevels.map((level) => (
            <Label key={level.id}>
              <RadioGroupItem value={level.id} />
              <div>{level.title}</div>
              <div>{level.scene}</div>
            </Label>
          ))}
        </RadioGroup>
        <Button onClick={handleConfirm}>ç¡®è®¤å¹¶å¼€å§‹ä½¿ç”¨</Button>
      </div>
    </div>
  );
}
```

**å…³é”®æ”¹è¿›ï¼š**

- âœ… ç§»é™¤äº† `useNavigate`ï¼Œæ”¹ç”¨ `<Navigate>` ç»„ä»¶
- âœ… ç§»é™¤äº† `setTimeout` å»¶è¿Ÿè·³è½¬
- âœ… ç§»é™¤äº† `state: { fromLevelSelection: true }` æ ‡è®°
- âœ… ä½¿ç”¨ `await refetch()` ç¡®ä¿ session æ›´æ–°å®Œæˆ
- âœ… è‡ªåŠ¨é‡å®šå‘ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ navigate
- âœ… ä»£ç ä» 197 è¡Œå‡å°‘åˆ° 165 è¡Œï¼ˆç®€åŒ– 17%ï¼‰

### 7. Dashboard NavBar æ˜¾ç¤ºè¯æ±‡ç­‰çº§

**æ–‡ä»¶ï¼š**`projects/client/src/components/layout/dashboard-navbar.tsx`

```typescript
export function DashboardNavbar() {
  const { user } = useAuth();
  const extendedUser = user as ExtendedUser | undefined;

  // è·å–è¯æ±‡ç­‰çº§æ˜¾ç¤ºä¿¡æ¯
  const vocabDisplay = getVocabularyDisplay(extendedUser?.vocabularyLevel);
  const badgeText = `${vocabDisplay.label} Â· ${vocabDisplay.wordCount}è¯`;

  return (
    <nav>
      {/* è¯æ±‡ç­‰çº§ Badge */}
      <Badge>{badgeText}</Badge>
    </nav>
  );
}
```

**ç‰¹ç‚¹ï¼š**

- âœ… å®æ—¶æ˜¾ç¤ºç”¨æˆ·çš„è¯æ±‡ç­‰çº§
- âœ… è‡ªåŠ¨åŒæ­¥æ›´æ–°ï¼ˆé€šè¿‡ refetchï¼‰
- âœ… ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®æºï¼ˆvocabulary.tsï¼‰

### 8. API æ¥å£

**åç«¯ï¼š**`projects/api/src/route/user.route.ts`

**PATCH `/api/users/me`** - æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…æ‹¬ `vocabularyLevel`ï¼‰

å·²åœ¨ `updateUserSchema` ä¸­å®šä¹‰éªŒè¯è§„åˆ™ï¼š

```typescript
vocabularyLevel: z.enum([
  "primary_school",
  "middle_school",
  "high_school",
  "cet4",
  "cet6",
  "ielts_toefl",
]).optional();
```

## è·¯ç”±é…ç½®

**æ–‡ä»¶ï¼š**`projects/client/src/App.tsx`

```typescript
<Route
  path="/level"
  element={
    <ProtectedRoute>
      <VocabLevelSelection />
    </ProtectedRoute>
  }
/>
<Route
  path="/dashboard"
  element={
    <ProtectedRoute>
      <DashboardPage />
    </ProtectedRoute>
  }
/>
```

ä¸¤ä¸ªè·¯ç”±éƒ½è¢« `ProtectedRoute` ä¿æŠ¤ï¼Œç¡®ä¿åªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½è®¿é—®ã€‚

## ç”¨æˆ·æµç¨‹

### é¦–æ¬¡æ³¨å†Œ/ç™»å½•

```
æ³¨å†Œ/ç™»å½•æˆåŠŸ
  â†“
è®¿é—® /dashboard
  â†“
æ£€æµ‹ vocabularyLevel = null
  â†“
<Navigate to="/level" replace />
  â†“
ç”¨æˆ·é€‰æ‹©è¯æ±‡ç­‰çº§
  â†“
ä¿å­˜ + await refetch()
  â†“
ç»„ä»¶é‡æ–°æ¸²æŸ“
  â†“
æ£€æµ‹åˆ° vocabularyLevel æœ‰å€¼
  â†“
<Navigate to="/dashboard" replace />
  â†“
æ˜¾ç¤º Dashboard å†…å®¹ âœ…
```

### åç»­è®¿é—®

```
è®¿é—® /dashboard
  â†“
æ£€æµ‹åˆ° vocabularyLevel å·²è®¾ç½®
  â†“
ç›´æ¥æ˜¾ç¤º Dashboard å†…å®¹ âœ…
```

## å…³é”®ç‰¹æ€§

### âœ… å£°æ˜å¼é‡å®šå‘

- ä½¿ç”¨ React Router çš„ `<Navigate>` ç»„ä»¶
- æ¯”å‘½ä»¤å¼çš„ `navigate()` æ›´å¯é 
- ä¸ä¼šæœ‰æ—¶åºå’ŒçŠ¶æ€ç®¡ç†é—®é¢˜

### âœ… æ•°æ®ç»Ÿä¸€ç®¡ç†

- `vocabulary.ts` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰è¯æ±‡ç­‰çº§æ•°æ®
- é¿å…åœ¨å¤šå¤„é‡å¤å®šä¹‰
- æ˜“äºç»´æŠ¤å’Œæ‰©å±•

### âœ… Session åŒæ­¥

- ä½¿ç”¨ Better Auth çš„ `refetch()` æ–¹æ³•åˆ·æ–° session
- ä½¿ç”¨ `await refetch()` ç¡®ä¿æ›´æ–°å®Œæˆ
- ç»„ä»¶è‡ªåŠ¨å“åº” session å˜åŒ–
- è¯¦è§ï¼š[æ›´æ–°ç”¨æˆ·ä¿¡æ¯åˆ·æ–° Session.md](./æ›´æ–°ç”¨æˆ·ä¿¡æ¯åˆ·æ–°Session.md)

### âœ… ç±»å‹å®‰å…¨

- ä½¿ç”¨ `ExtendedUser` ç±»å‹ç¡®ä¿ TypeScript ç±»å‹æ£€æŸ¥
- ä½¿ç”¨ `VocabularyLevel` ç±»å‹å®šä¹‰
- æ‰€æœ‰æšä¸¾å€¼ä¸æ•°æ®åº“ä¸€è‡´

### âœ… ç®€æ´é«˜æ•ˆ

- Dashboard: 105 è¡Œ â†’ 42 è¡Œï¼ˆç®€åŒ– 60%ï¼‰
- Vocab-level: 197 è¡Œ â†’ 165 è¡Œï¼ˆç®€åŒ– 17%ï¼‰
- æ€»å…±å‡å°‘ **97 è¡Œä»£ç **
- é€»è¾‘æ›´æ¸…æ™°ï¼Œæ˜“äºç†è§£

### âœ… ç”¨æˆ·ä½“éªŒ

- æ— å»¶è¿Ÿï¼Œç«‹å³è·³è½¬
- æµç•…çš„é¡µé¢åˆ‡æ¢
- Toast æ¶ˆæ¯åé¦ˆ
- æ— é¡µé¢åˆ·æ–°ï¼Œä¿æŒ SPA ä½“éªŒ

## æ¶æ„ä¼˜åŠ¿

### ä¹‹å‰çš„é—®é¢˜

- âŒ ä½¿ç”¨ `useState` ç®¡ç† `shouldRedirect` çŠ¶æ€
- âŒ ä½¿ç”¨ `useEffect` ç›‘å¬å¹¶å»¶è¿Ÿè·³è½¬
- âŒ ä½¿ç”¨ `setTimeout` é€ æˆæ—¶åºé—®é¢˜
- âŒ ä½¿ç”¨ `location.state.fromLevelSelection` æ ‡è®°ï¼Œå¯¼è‡´åˆ·æ–° bug
- âŒ é‡å¤æ£€æŸ¥é€»è¾‘ï¼ˆä¸‰å±‚æ£€æŸ¥ï¼‰
- âŒ ä»£ç å¤æ‚ï¼Œéš¾ä»¥ç»´æŠ¤

### ç°åœ¨çš„æ–¹æ¡ˆ

- âœ… ä½¿ç”¨ `<Navigate>` å£°æ˜å¼ç»„ä»¶
- âœ… ç§»é™¤æ‰€æœ‰ state å’Œ useEffect
- âœ… ç§»é™¤ setTimeout å»¶è¿Ÿ
- âœ… ç§»é™¤ location.state æ ‡è®°
- âœ… å•ä¸€æ£€æŸ¥ç‚¹ï¼Œé€»è¾‘æ¸…æ™°
- âœ… ä»£ç ç®€æ´ï¼Œæ˜“äºç»´æŠ¤

## æ³¨æ„äº‹é¡¹

1. **Session åˆ·æ–°æœºåˆ¶**ï¼š

   - æ›´æ–°ç”¨æˆ·ä¿¡æ¯åå¿…é¡»è°ƒç”¨ `await refetch()` ç­‰å¾…åˆ·æ–°å®Œæˆ
   - ç»„ä»¶ä¼šè‡ªåŠ¨å“åº” session å˜åŒ–å¹¶é‡æ–°æ¸²æŸ“
   - æ— éœ€æ‰‹åŠ¨è°ƒç”¨ `navigate()`

2. **é‡å®šå‘ä½¿ç”¨ `replace: true`**ï¼š

   - é¿å…ç”¨æˆ·æŒ‰è¿”å›é”®æ—¶å›åˆ°ä¹‹å‰çš„é¡µé¢
   - æä¾›æ›´å¥½çš„å¯¼èˆªä½“éªŒ

3. **ç±»å‹æ–­è¨€**ï¼š

   - ä½¿ç”¨ `as ExtendedUser` ç¡®ä¿ TypeScript è¯†åˆ«è‡ªå®šä¹‰å­—æ®µ
   - Better Auth çš„ç±»å‹æ‰©å±•åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸ç”Ÿæ•ˆ

4. **æ•°æ®ç»Ÿä¸€ç®¡ç†**ï¼š
   - æ‰€æœ‰è¯æ±‡ç­‰çº§æ•°æ®å®šä¹‰åœ¨ `vocabulary.ts`
   - é¿å…åœ¨å¤šå¤„é‡å¤å®šä¹‰ç›¸åŒæ•°æ®

## æµ‹è¯•å»ºè®®

1. **é¦–æ¬¡ç”¨æˆ·æµ‹è¯•**ï¼š

   - æ–°æ³¨å†Œç”¨æˆ·ï¼ŒéªŒè¯æ˜¯å¦è‡ªåŠ¨è·³è½¬åˆ° `/level`
   - é€‰æ‹©ç­‰çº§åï¼ŒéªŒè¯æ˜¯å¦èƒ½æ­£å¸¸è¿›å…¥ Dashboard
   - éªŒè¯ NavBar æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºè¯æ±‡ç­‰çº§

2. **è€ç”¨æˆ·æµ‹è¯•**ï¼š

   - å·²æœ‰ `vocabularyLevel` çš„ç”¨æˆ·ï¼ŒéªŒè¯ç›´æ¥è®¿é—® Dashboard
   - éªŒè¯åˆ·æ–°é¡µé¢å NavBar æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸

3. **è¾¹ç•Œæƒ…å†µ**ï¼š
   - æœªç™»å½•ç”¨æˆ·è®¿é—® `/level` å’Œ `/dashboard`ï¼ŒéªŒè¯ `ProtectedRoute` æ˜¯å¦ç”Ÿæ•ˆ
   - åˆ é™¤ç”¨æˆ·çš„ `vocabularyLevel`ï¼Œåˆ·æ–° `/dashboard` éªŒè¯æ˜¯å¦æ­£å¸¸è·³è½¬
   - å·²æœ‰ç­‰çº§çš„ç”¨æˆ·è®¿é—® `/level`ï¼ŒéªŒè¯æ˜¯å¦è·³è½¬å› Dashboard

## ç›¸å…³æ–‡ä»¶

- `projects/client/src/pages/dashboard.tsx` - Dashboard é¡µé¢
- `projects/client/src/pages/vocab-level.tsx` - è¯æ±‡ç­‰çº§é€‰æ‹©é¡µé¢
- `projects/client/src/utils/vocabulary.ts` - è¯æ±‡ç­‰çº§æ•°æ®ç®¡ç†
- `projects/client/src/components/layout/dashboard-navbar.tsx` - NavBar ç»„ä»¶
- `projects/client/src/hooks/use-auth.ts` - è®¤è¯ Hook
- `projects/api/src/route/user.route.ts` - ç”¨æˆ·ä¿¡æ¯æ›´æ–° API

## ç›¸å…³æ–‡æ¡£

- [æ›´æ–°ç”¨æˆ·ä¿¡æ¯åˆ·æ–° Session.md](./æ›´æ–°ç”¨æˆ·ä¿¡æ¯åˆ·æ–°Session.md)
- [Session è®¤è¯ä½¿ç”¨æŒ‡å—.md](./Sessionè®¤è¯ä½¿ç”¨æŒ‡å—.md)

## æ€»ç»“

é€šè¿‡é‡‡ç”¨å£°æ˜å¼é‡å®šå‘ã€ç»Ÿä¸€æ•°æ®ç®¡ç†ã€ç®€åŒ–çŠ¶æ€ç®¡ç†ç­‰ä¼˜åŒ–æ‰‹æ®µï¼Œæ–°ç‰ˆæœ¬çš„è¯æ±‡ç­‰çº§é€‰æ‹©åŠŸèƒ½æ›´åŠ ç®€æ´ã€å¯é ã€æ˜“äºç»´æŠ¤ã€‚ä»£ç é‡å‡å°‘äº†è¿‘ 100 è¡Œï¼ŒåŒæ—¶æ¶ˆé™¤äº†ä¹‹å‰å­˜åœ¨çš„å„ç§ bug å’Œè¾¹ç•Œæƒ…å†µé—®é¢˜ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ›´æµç•…çš„ä½“éªŒã€‚
